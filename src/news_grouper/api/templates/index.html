<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="{{ url_for('static', filename='icon.ico') }}">
    <title>News Grouper</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Remove all scroll-behavior CSS - we'll handle this in JavaScript */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: row;
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }

        /* Enhanced smooth scrolling for WebKit browsers */
        @supports (-webkit-overflow-scrolling: touch) {
            .sidebar, .main-content, .container, .news-content, .sources-list {
                -webkit-overflow-scrolling: touch;
            }
        }

        .sidebar {
            width: 280px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            padding: 30px 24px;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            display: flex;
            flex-direction: column;
            gap: 24px;
            box-shadow: 2px 0 16px rgba(102, 126, 234, 0.15);
            z-index: 100;
            overflow-y: auto;
        }

        .sidebar h1 {
            font-size: 1.8em;
            margin-bottom: 20px;
            color: #fff;
            text-align: center;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar .logo {
            width: 100%;
        }

        .sidebar nav {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .sidebar nav a {
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            font-weight: 500;
            font-size: 1em;
            padding: 12px 16px;
            border-radius: 8px;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            cursor: pointer;
            display: block;
        }

        .sidebar nav a.active,
        .sidebar nav a:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
            border-color: rgba(255, 255, 255, 0.2);
        }

        .sidebar .profile-info {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            padding: 16px;
            border-radius: 12px;
            font-size: 0.9em;
            margin-top: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .main-content {
            flex: 1;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin-left: 280px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08);
            backdrop-filter: blur(10px);
            margin: 20px 0;
        }

        .section-divider {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            padding: 20px 32px;
            margin: 48px 0 32px 0;
            border-radius: 16px;
            font-weight: 600;
            font-size: 1.2em;
            text-align: center;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.25);
            position: relative;
        }

        .section-divider::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 18px;
            z-index: -1;
            opacity: 0.3;
        }

        #messages {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
        }

        #messages .error,
        #messages .success {
            padding: 16px 20px;
            margin-bottom: 12px;
            border-radius: 8px;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #messages .error {
            background: #fee;
            color: #c53030;
            border: 1px solid #feb2b2;
        }

        #messages .success {
            background: #f0fff4;
            color: #38a169;
            border: 1px solid #9ae6b4;
        }

        .section {
            margin-bottom: 32px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(102, 126, 234, 0.1);
            overflow: hidden;
            display: none;
        }

        .section.active {
            display: block;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            background: rgba(102, 126, 234, 0.05);
            border-bottom: 1px solid rgba(102, 126, 234, 0.1);
        }

        .section-header h2 {
            color: #2d3748;
            font-size: 1.25em;
            margin: 0;
            font-weight: 600;
        }

        .section-content {
            padding: 24px;
        }

        .fetch-news-section {
            background: rgba(102, 126, 234, 0.05);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .fetch-news-section h3 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.1em;
            font-weight: 600;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
        }

        .form-section {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .form-section h3 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.1em;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 500;
            font-size: 0.95em;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.95em;
            transition: all 0.2s ease;
            background: #fff;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group small {
            color: #718096;
            font-size: 0.85em;
            margin-top: 4px;
            display: block;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .datetime-group {
            display: flex;
            gap: 16px;
        }

        .datetime-group .form-group {
            flex: 1;
        }

        .file-input-wrapper {
            position: relative;
            display: block;
            width: 100%;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-display {
            background: #f8f9fa;
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #4a5568;
        }

        .file-input-display:hover {
            background: rgba(102, 126, 234, 0.05);
            border-color: #667eea;
        }

        .sources-list {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(102, 126, 234, 0.1);
            max-height: 400px;
            overflow-y: auto;
        }

        .source-item {
            background: #f8f9fa;
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        .source-item:hover {
            background: #f1f5f9;
            border-color: #cbd5e0;
        }

        .source-item:last-child {
            margin-bottom: 0;
        }

        .source-info {
            flex: 1;
        }

        .source-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .source-details {
            color: #718096;
            font-size: 0.9em;
        }

        .source-item button {
            background: #e53e3e;
            padding: 8px 16px;
            font-size: 0.85em;
            margin-left: 12px;
        }

        .source-item button:hover {
            background: #c53030;
        }

        .source-item.selected {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .source-item.selected .source-name {
            color: #667eea;
            font-weight: 700;
        }

        .source-item.selected .source-name::before {
            content: '✓ ';
            color: #667eea;
            font-weight: bold;
        }

        .source-item.selected .source-details {
            color: #5a67d8;
        }

        .news-content {
            background: transparent;
            border-radius: 0;
            padding: 0;
            box-shadow: none;
            border: none;
            max-height: none;
            overflow: visible;
        }

        .post-group {
            background: #fff;
            border-radius: 16px;
            padding: 28px;
            margin-bottom: 32px;
            border: 1px solid rgba(102, 126, 234, 0.15);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .post-group:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .post-group::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .post-group-summary {
            font-weight: 500;
            color: #2d3748;
            margin-bottom: 24px;
            font-size: 1.1em;
            line-height: 1.7;
            padding: 20px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.08), rgba(118, 75, 162, 0.08));
            border-radius: 12px;
            border-left: 4px solid #667eea;
            white-space: pre-wrap;
        }

        .post-item {
            background: #f8f9fa;
            padding: 20px;
            margin-bottom: 16px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
            position: relative;
        }

        .post-item:hover {
            border-color: #cbd5e0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transform: translateY(-1px);
        }

        .post-item:last-child {
            margin-bottom: 0;
        }

        .post-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 12px;
            font-size: 1.15em;
            line-height: 1.4;
        }

        .post-author {
            color: #667eea;
            font-size: 0.9em;
            margin-bottom: 12px;
            font-weight: 500;
        }

        .post-body {
            color: #4a5568;
            line-height: 1.7;
            margin-bottom: 16px;
            font-size: 0.95em;
            white-space: pre-wrap;
        }

        .post-body.collapsed {
            max-height: 120px;
            overflow: hidden;
            position: relative;
        }

        .post-body.collapsed::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40px;
            background: linear-gradient(transparent, #f8f9fa);
        }

        .expand-toggle {
            background: none;
            border: none;
            color: #667eea;
            font-weight: 500;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 8px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .expand-toggle:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: none;
            box-shadow: none;
        }

        .post-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e2e8f0;
        }

        .post-link a {
            color: #667eea;
            text-decoration: none;
            font-size: 0.9em;
            font-weight: 500;
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }

        .post-link a:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: #667eea;
            text-decoration: none;
        }

        .post-time {
            color: #a0aec0;
            font-size: 0.85em;
            font-weight: 500;
        }

        .individual-post {
            background: #fff;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid rgba(102, 126, 234, 0.15);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }

        .individual-post:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .individual-post .post-title {
            font-size: 1.25em;
            margin-bottom: 16px;
            color: #2d3748;
        }

        .individual-post .post-body {
            font-size: 1em;
            line-height: 1.7;
            color: #4a5568;
        }

        .pagination {
            text-align: center;
            margin: 48px 0;
            padding: 24px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            border: 1px solid rgba(102, 126, 234, 0.1);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
        }

        .pagination button {
            margin: 0 12px;
            padding: 12px 24px;
            font-size: 0.95em;
            border-radius: 8px;
        }

        .pagination span {
            color: #4a5568;
            font-weight: 600;
            font-size: 1em;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
            font-size: 1.1em;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .stats-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            margin-bottom: 24px;
            border: 1px solid rgba(102, 126, 234, 0.1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .stats-item {
            text-align: center;
            color: #4a5568;
            font-size: 0.9em;
        }

        .stats-item .number {
            font-size: 1.5em;
            font-weight: 600;
            color: #667eea;
            display: block;
        }

        .ref-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
            padding: 2px 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
            display: inline;
            margin: 0 1px;
            font-size: 0.95em;
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .ref-link:hover {
            background: rgba(102, 126, 234, 0.2);
            text-decoration: none;
            transform: none;
            box-shadow: none;
        }

        .algorithm-description {
            margin-top: 8px;
            padding: 12px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 6px;
            border: 1px solid rgba(102, 126, 234, 0.1);
            color: #4a5568;
            font-size: 0.9em;
            line-height: 1.5;
            display: none;
        }

        .algorithm-description.visible {
            display: block;
        }

        @media (max-width: 1200px) {
            .sidebar {
                width: 240px;
                padding: 20px 16px;
            }

            .container {
                padding: 24px;
            }
        }

        @media (max-width: 900px) {
            .grid {
                grid-template-columns: 1fr;
                gap: 24px;
            }

            .main-content {
                padding: 12px;
            }

            .container {
                padding: 20px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: static;
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
                padding: 16px;
            }

            .sidebar h1 {
                font-size: 1.5em;
                margin-bottom: 0;
            }

            .sidebar .logo {
                width: 36px;
                height: 36px;
            }

            .sidebar nav {
                flex-direction: row;
                gap: 8px;
            }

            .sidebar nav a {
                padding: 8px 12px;
                font-size: 0.9em;
            }

            .sidebar .profile-info {
                display: none;
            }

            .main-content {
                margin-left: 0;
                padding: 8px;
                align-items: stretch;
            }

            .container {
                padding: 20px;
                margin: 0;
            }

            .section-divider {
                margin: 20px -20px 16px -20px;
                padding: 12px 20px;
                font-size: 1em;
            }

            .section-content {
                padding: 16px;
            }

            .form-section {
                padding: 16px;
            }

            .datetime-group {
                flex-direction: column;
                gap: 12px;
            }

            #messages {
                position: static;
                margin-bottom: 16px;
                max-width: none;
            }
        }

        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fff;
            padding: 40px;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            position: relative;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #000;
        }

        .auth-form h2 {
            margin-bottom: 24px;
            color: #2d3748;
            text-align: center;
        }

        .auth-form p {
            text-align: center;
            margin-top: 16px;
        }

        .auth-form a {
            color: #667eea;
            text-decoration: none;
        }

        .auth-form a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <!-- Login/Register Modal -->
    <div id="auth-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="login-form" class="auth-form">
                <h2>Login</h2>
                <form id="login-form-element">
                    <div class="form-group">
                        <label for="login-email">Email:</label>
                        <input type="email" id="login-email" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">Password:</label>
                        <input type="password" id="login-password" required>
                    </div>
                    <button type="submit">Login</button>
                    <p><a href="#" id="show-register">Don't have an account? Register</a></p>
                </form>
            </div>
            <div id="register-form" class="auth-form" style="display: none;">
                <h2>Register</h2>
                <form id="register-form-element">
                    <div class="form-group">
                        <label for="register-first-name">First Name:</label>
                        <input type="text" id="register-first-name" required>
                    </div>
                    <div class="form-group">
                        <label for="register-last-name">Last Name:</label>
                        <input type="text" id="register-last-name" required>
                    </div>
                    <div class="form-group">
                        <label for="register-email">Email:</label>
                        <input type="email" id="register-email" required>
                    </div>
                    <div class="form-group">
                        <label for="register-password">Password:</label>
                        <input type="password" id="register-password" required>
                    </div>
                    <div class="form-group">
                        <label for="register-api-key">Gemini API Key:</label>
                        <input type="text" id="register-api-key" required>
                        <small>Отримати можна <a href="https://aistudio.google.com/apikey" target="_blank">тут</a>. Інструкція <a href="https://ai.google.dev/gemini-api/docs/api-key" target="_blank">тут</a>.</small>
                    </div>
                    <button type="submit">Register</button>
                    <p><a href="#" id="show-login">Already have an account? Login</a></p>
                </form>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <h1>
            <img src="{{ url_for('static', filename='icon.svg') }}" alt="News Grouper Logo" class="logo">
        </h1>
        <nav>
            <a href="#" data-tab="auth-section" class="active">Authentication</a>
            <a href="#" data-tab="profile-section">Profiles</a>
            <a href="#" data-tab="sources-section">Sources</a>
            <a href="#" data-tab="news-section">Fetch News</a>
        </nav>
        <div id="current-profile" class="profile-info" style="display: none;">
            <strong>Current Profile:</strong> <span id="profile-name"></span><br>
            <span id="profile-description"></span>
        </div>
        <div id="user-info" class="profile-info" style="display: none;">
            <strong>Logged in as:</strong> <span id="user-name"></span><br>
            <span id="user-email"></span><br>
            <button id="logout-btn" style="margin-top: 10px; padding: 8px 16px; font-size: 0.8em;">Logout</button>
        </div>
    </div>

    <div class="main-content">
        <div id="messages"></div>

        <div class="container">
            <!-- Authentication Section -->
            <div class="section active" id="auth-section">
                <div class="section-header">
                    <h2>Authentication</h2>
                </div>
                <div class="section-content">
                    <div id="auth-not-logged-in" class="grid">
                        <div class="form-section">
                            <h3>Login</h3>
                            <form id="login-form-main">
                                <div class="form-group">
                                    <label for="main-login-email">Email:</label>
                                    <input type="email" id="main-login-email" required>
                                </div>
                                <div class="form-group">
                                    <label for="main-login-password">Password:</label>
                                    <input type="password" id="main-login-password" required>
                                </div>
                                <button type="submit">Login</button>
                            </form>
                        </div>
                        <div class="form-section">
                            <h3>Register</h3>
                            <form id="register-form-main">
                                <div class="form-group">
                                    <label for="main-register-first-name">First Name:</label>
                                    <input type="text" id="main-register-first-name" required>
                                </div>
                                <div class="form-group">
                                    <label for="main-register-last-name">Last Name:</label>
                                    <input type="text" id="main-register-last-name" required>
                                </div>
                                <div class="form-group">
                                    <label for="main-register-email">Email:</label>
                                    <input type="email" id="main-register-email" required>
                                <div class="form-group">
                                    <label for="main-register-api-key">Gemini API Key:</label>
                                    <input type="text" id="main-register-api-key" required>
                                    <small>You can get it <a href="https://aistudio.google.com/apikey" target="_blank">here</a>. Instruction is <a href="https://www.youtube.com/watch?v=6BRyynZkvf0" target="_blank">here</a>.</small>
                                </div>
                                </div>
                                <div class="form-group">
                                    <label for="main-register-password">Password:</label>
                                    <input type="password" id="main-register-password" required>
                                </div>
                                <button type="submit">Register</button>
                            </form>
                        </div>
                    </div>
                    <div id="auth-logged-in" style="display: none;">
                        <div class="form-section">
                            <h3>User Information</h3>
                            <div id="user-details">
                                <div class="form-group">
                                    <label>Name:</label>
                                    <div id="user-full-name" style="padding: 12px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e2e8f0;"></div>
                                </div>
                                <div class="form-group">
                                    <label>Email:</label>
                                    <div id="user-email-display" style="padding: 12px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e2e8f0;"></div>
                                </div>
                                <div class="form-group">
                                    <label>Account Created:</label>
                                    <div id="user-created" style="padding: 12px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e2e8f0;"></div>
                                </div>
                                <button id="logout-btn-main" style="background: #e74c3c; margin-top: 16px;">Logout</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Management -->
            <div class="section" id="profile-section">
                <div class="section-header">
                    <h2>Profile Management</h2>
                </div>
                <div class="section-content">
                    <div class="grid">
                        <div class="form-section">
                            <h3>Create New Profile</h3>
                            <form id="create-profile-form">
                                <div class="form-group">
                                    <label for="new-profile-name">Name:</label>
                                    <input type="text" id="new-profile-name" required>
                                </div>
                                <div class="form-group">
                                    <label for="new-profile-description">Description:</label>
                                    <textarea id="new-profile-description" rows="3" required></textarea>
                                </div>
                                <button type="submit">Create Profile</button>
                            </form>
                        </div>

                        <div>
                            <h3 style="margin-bottom: 16px; color: #2d3748; font-size: 1.1em; font-weight: 600;">Your Profiles</h3>
                            <div id="profiles-list" class="sources-list">
                                <div class="loading">Loading profiles...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- News Sources Management -->
            <div class="section" id="sources-section">
                <div class="section-header">
                    <h2>News Sources</h2>
                </div>
                <div class="section-content">
                    <div class="grid">
                        <div class="form-section">
                            <h3>Add New Source</h3>
                            <form id="add-source-form">
                                <div class="form-group">
                                    <label for="source-name">Name:</label>
                                    <input type="text" id="source-name" required>
                                </div>
                                <div class="form-group">
                                    <label for="source-parser">Parser:</label>
                                    <select id="source-parser" required>
                                        <option value="">Select a parser...</option>
                                    </select>
                                    <div id="parser-description" class="algorithm-description"></div>
                                </div>
                                <div class="form-group">
                                    <label for="source-link">Link:</label>
                                    <input type="text" id="source-link" required>
                                    <small id="parser-hint"></small>
                                </div>
                                <button type="submit">Add Source</button>
                            </form>
                        </div>

                        <div>
                            <h3 style="margin-bottom: 16px; color: #2d3748; font-size: 1.1em; font-weight: 600;">Current Sources</h3>
                            <div id="sources-list" class="sources-list">
                                <div class="loading">Select a profile to view sources</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- News Fetching & Display Combined -->
            <div class="section" id="news-section">
                <div class="section-header">
                    <h2>Fetch News</h2>
                </div>
                <div class="section-content">
                    <!-- Fetch News Form -->
                    <div class="fetch-news-section">
                        <h3>Fetch News</h3>
                        <form id="fetch-news-form">
                            <div class="form-group">
                                <label for="grouper-select">Grouper:</label>
                                <select id="grouper-select" required>
                                    <option value="">Select a grouper...</option>
                                </select>
                                <div id="grouper-description" class="algorithm-description"></div>
                            </div>
                            <div class="datetime-group">
                                <div class="form-group">
                                    <label for="from-datetime">From Date:</label>
                                    <input type="datetime-local" id="from-datetime" required>
                                </div>
                                <div class="form-group">
                                    <label for="to-datetime">To Date:</label>
                                    <input type="datetime-local" id="to-datetime">
                                </div>
                            </div>
                            <button type="submit">Fetch News</button>
                        </form>
                    </div>

                    <!-- News Display -->
                    <div>
                        <h3 style="margin-bottom: 16px; color: #2d3748; font-size: 1.1em; font-weight: 600;">News Content</h3>
                        <div id="news-content" class="news-content">
                            <div class="loading">Select a profile and fetch news to see content here</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentProfile = null;
        let currentUser = null;
        let accessToken = null;
        let parsers = [];
        let groupers = [];
        let isAuthenticated = false;

        // Pagination state for unified list
        let newsPagination = {
            combined: [],
            page: 1,
            perPage: 5
        };

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            loadFromLocalStorage();
            checkAuthentication();
        });

        function loadFromLocalStorage() {
            // Load current profile from localStorage
            const storedProfile = localStorage.getItem('currentProfile');
            if (storedProfile) {
                try {
                    currentProfile = JSON.parse(storedProfile);
                    updateProfileDisplay();
                } catch (e) {
                    localStorage.removeItem('currentProfile');
                }
            }

            // Load access token from localStorage
            const storedToken = localStorage.getItem('accessToken');
            if (storedToken) {
                accessToken = storedToken;
            }
        }

        function saveToLocalStorage() {
            if (currentProfile) {
                localStorage.setItem('currentProfile', JSON.stringify(currentProfile));
            } else {
                localStorage.removeItem('currentProfile');
            }

            if (accessToken) {
                localStorage.setItem('accessToken', accessToken);
            } else {
                localStorage.removeItem('accessToken');
            }
        }

        async function checkAuthentication() {
            // Always load parsers and groupers regardless of authentication
            await loadParsers();
            await loadGroupers();

            // First try to use stored token
            if (accessToken) {
                try {
                    currentUser = await apiCall('/whoami');
                    isAuthenticated = true;
                    updateAuthDisplay();
                    await loadProfiles();
                    switchTab('profile-section');
                    return;
                } catch (error) {
                    // Token might be expired, try to refresh
                    try {
                        await refreshToken();
                        currentUser = await apiCall('/whoami');
                        isAuthenticated = true;
                        updateAuthDisplay();
                        await loadProfiles();
                        switchTab('profile-section');
                        return;
                    } catch (refreshError) {
                        // Refresh failed, clear everything
                        accessToken = null;
                        currentUser = null;
                        isAuthenticated = false;
                        saveToLocalStorage();
                    }
                }
            }

            // If we reach here, user is not authenticated
            // Try to refresh token anyway in case there's a refresh cookie
            try {
                await refreshToken();
                currentUser = await apiCall('/whoami');
                isAuthenticated = true;
                updateAuthDisplay();
                await loadProfiles();
                switchTab('profile-section');
            } catch (error) {
                // No valid authentication, show login form
                isAuthenticated = false;
                updateAuthDisplay();
            }
        }

        async function refreshToken() {
            // Get CSRF token from cookie
            const csrfToken = getCookie('csrf_refresh_token');

            const headers = {
                'Content-Type': 'application/json'
            };

            if (csrfToken) {
                headers['X-CSRF-TOKEN'] = csrfToken;
            }

            const response = await fetch('/api/refresh', {
                method: 'POST',
                headers: headers
            });

            if (!response.ok) {
                throw new Error('Token refresh failed');
            }

            const data = await response.json();
            accessToken = data.access_token;
            saveToLocalStorage();
        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        function setupEventListeners() {
            // Auth modal
            document.getElementById('show-register').addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('register-form').style.display = 'block';
            });

            document.getElementById('show-login').addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('register-form').style.display = 'none';
                document.getElementById('login-form').style.display = 'block';
            });

            document.querySelector('.close').addEventListener('click', hideAuthModal);

            // Auth forms
            document.getElementById('login-form-element').addEventListener('submit', handleLogin);
            document.getElementById('register-form-element').addEventListener('submit', handleRegister);
            document.getElementById('login-form-main').addEventListener('submit', handleMainLogin);
            document.getElementById('register-form-main').addEventListener('submit', handleMainRegister);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('logout-btn-main').addEventListener('click', handleLogout);

            // Tab navigation - Remove authentication checks
            document.querySelectorAll('.sidebar nav a').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const tabId = this.getAttribute('data-tab');

                    // Handle tab-specific actions when switching to them
                    handleTabSwitch(tabId);

                    switchTab(tabId);
                });
            });

            // Profile creation
            document.getElementById('create-profile-form').addEventListener('submit', createProfile);

            // Source management
            document.getElementById('add-source-form').addEventListener('submit', addSource);
            document.getElementById('source-parser').addEventListener('change', updateParserInfo);

            // News fetching
            document.getElementById('fetch-news-form').addEventListener('submit', fetchNews);
            document.getElementById('grouper-select').addEventListener('change', updateGrouperInfo);
        }

        // Handle tab-specific actions when switching tabs
        async function handleTabSwitch(tabId) {
            switch (tabId) {
                case 'profile-section':
                    if (isAuthenticated) {
                        await loadProfiles();
                    } else {
                        document.getElementById('profiles-list').innerHTML = '<div class="loading">Please log in to view profiles</div>';
                    }
                    break;
                case 'sources-section':
                    // Always load parsers when visiting sources tab
                    await loadParsers();
                    if (isAuthenticated) {
                        await loadSources();
                    } else {
                        document.getElementById('sources-list').innerHTML = '<div class="loading">Please log in to view sources</div>';
                    }
                    break;
                case 'news-section':
                    // Always load groupers when visiting news tab
                    await loadGroupers();
                    if (!isAuthenticated) {
                        document.getElementById('news-content').innerHTML = '<div class="loading">Please log in to fetch news</div>';
                    }
                    break;
            }
        }

        function updateAuthDisplay() {
            if (isAuthenticated && currentUser) {
                document.getElementById('auth-not-logged-in').style.display = 'none';
                document.getElementById('auth-logged-in').style.display = 'block';
                document.getElementById('user-info').style.display = 'block';

                // Update user info in sidebar
                document.getElementById('user-name').textContent = `${currentUser.first_name} ${currentUser.last_name}`;
                document.getElementById('user-email').textContent = currentUser.email;

                // Update user info in auth section
                document.getElementById('user-full-name').textContent = `${currentUser.first_name} ${currentUser.last_name}`;
                document.getElementById('user-email-display').textContent = currentUser.email;
                document.getElementById('user-created').textContent = formatLocalTime(currentUser.created);

                hideAuthModal();
            } else {
                document.getElementById('auth-not-logged-in').style.display = 'block';
                document.getElementById('auth-logged-in').style.display = 'none';
                document.getElementById('user-info').style.display = 'none';
            }
        }

        function showAuthModal() {
            document.getElementById('auth-modal').style.display = 'block';
        }

        function hideAuthModal() {
            document.getElementById('auth-modal').style.display = 'none';
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            await performLogin(email, password);
        }

        async function handleMainLogin(e) {
            e.preventDefault();
            const email = document.getElementById('main-login-email').value;
            const password = document.getElementById('main-login-password').value;
            await performLogin(email, password);
        }

        async function performLogin(email, password) {
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Login failed');
                }

                const data = await response.json();
                accessToken = data.access_token;
                saveToLocalStorage();

                await checkAuthentication();
                showMessage('Logged in successfully!', 'success');

                // Clear form fields
                document.getElementById('login-email').value = '';
                document.getElementById('login-password').value = '';
                document.getElementById('main-login-email').value = '';
                document.getElementById('main-login-password').value = '';

                // Switch to profiles tab after successful login
                switchTab('profile-section');
            } catch (error) {
                showMessage(error.message, 'error');
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const firstName = document.getElementById('register-first-name').value;
            const lastName = document.getElementById('register-last-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const apiKey = document.getElementById('register-api-key').value;
            await performRegister(firstName, lastName, email, password, apiKey);
        }

        async function handleMainRegister(e) {
            e.preventDefault();
            const firstName = document.getElementById('main-register-first-name').value;
            const lastName = document.getElementById('main-register-last-name').value;
            const email = document.getElementById('main-register-email').value;
            const password = document.getElementById('main-register-password').value;
            const apiKey = document.getElementById('main-register-api-key').value;
            await performRegister(firstName, lastName, email, password, apiKey);
        }

        async function performRegister(firstName, lastName, email, password, apiKey) {
            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        first_name: firstName,
                        last_name: lastName,
                        email,
                        password,
                        gemini_api_key: apiKey
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Registration failed');
                }

                const data = await response.json();
                accessToken = data.access_token;
                saveToLocalStorage();

                await checkAuthentication();
                showMessage('Registered successfully!', 'success');

                // Clear form fields
                document.getElementById('register-first-name').value = '';
                document.getElementById('register-last-name').value = '';
                document.getElementById('register-email').value = '';
                document.getElementById('register-password').value = '';
                document.getElementById('register-api-key').value = '';
                document.getElementById('main-register-first-name').value = '';
                document.getElementById('main-register-last-name').value = '';
                document.getElementById('main-register-email').value = '';
                document.getElementById('main-register-password').value = '';
                document.getElementById('main-register-api-key').value = '';

                // Switch to profiles tab after successful registration
                switchTab('profile-section');
            } catch (error) {
                showMessage(error.message, 'error');
            }
        }

        async function handleLogout() {
            try {
                await apiCall('/logout', { method: 'POST' });
            } catch (error) {
                // Ignore logout errors
            }

            accessToken = null;
            currentUser = null;
            currentProfile = null;
            isAuthenticated = false;
            localStorage.clear();

            updateAuthDisplay();
            updateProfileDisplay();
            showMessage('Logged out successfully!', 'success');

            // Switch to auth tab after logout
            switchTab('auth-section');
        }

        function switchTab(tabId) {
            // Remove active class from all sections and nav links
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.sidebar nav a').forEach(link => {
                link.classList.remove('active');
            });

            // Add active class to selected section and nav link
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
        }

        async function apiCall(endpoint, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };

            if (accessToken) {
                headers['Authorization'] = `Bearer ${accessToken}`;
            }

            try {
                const response = await fetch(`/api${endpoint}`, {
                    headers,
                    ...options
                });

                if (response.status === 401) {
                    // Token expired, try to refresh
                    try {
                        await refreshToken();
                        // Retry the original request
                        headers['Authorization'] = `Bearer ${accessToken}`;
                        const retryResponse = await fetch(`/api${endpoint}`, {
                            headers,
                            ...options
                        });

                        if (!retryResponse.ok) {
                            const error = await retryResponse.json();
                            throw new Error(error.message || 'API request failed');
                        }

                        const text = await retryResponse.text();
                        return text ? JSON.parse(text) : {};
                    } catch (refreshError) {
                        // Refresh failed, redirect to login
                        accessToken = null;
                        currentUser = null;
                        isAuthenticated = false;
                        saveToLocalStorage();
                        updateAuthDisplay();
                        switchTab('auth-section');
                        throw new Error('Session expired. Please log in again.');
                    }
                }

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'API request failed');
                }

                const text = await response.text();
                return text ? JSON.parse(text) : {};
            } catch (error) {
                showMessage(error.message, 'error');
                throw error;
            }
        }

        // Function to convert server time to local timezone
        function formatLocalTime(timeString) {
            if (!timeString) return '';
            const date = new Date(timeString);
            if (isNaN(date.getTime())) {
                return timeString;
            }
            return date.toLocaleString();
        }

        function updateProfileDisplay() {
            if (currentProfile) {
                document.getElementById('current-profile').style.display = 'block';
                document.getElementById('profile-name').textContent = currentProfile.name;
                document.getElementById('profile-description').textContent = currentProfile.description || '';
            } else {
                document.getElementById('current-profile').style.display = 'none';
            }
        }

        async function loadProfiles() {
            try {
                const response = await apiCall('/profiles');
                const profiles = response.items || [];
                const profilesList = document.getElementById('profiles-list');

                if (profiles.length === 0) {
                    profilesList.innerHTML = '<div class="loading">No profiles found. Create one to get started!</div>';
                    return;
                }

                profilesList.innerHTML = profiles.map(profile => {
                    const isSelected = currentProfile && currentProfile.id === profile.id;
                    return `
                        <div class="source-item ${isSelected ? 'selected' : ''}">
                            <div class="source-info">
                                <div class="source-name">${profile.name}</div>
                                <div class="source-details">${profile.description}</div>
                            </div>
                            <div>
                                <button onclick="selectProfile(${profile.id})" style="background: #667eea; margin-right: 8px;">${isSelected ? 'Selected' : 'Select'}</button>
                                <button onclick="deleteProfile(${profile.id})" style="background: #e74c3c;">Delete</button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                document.getElementById('profiles-list').innerHTML = '<div class="loading">Failed to load profiles</div>';
            }
        }

        async function selectProfile(profileId) {
            try {
                currentProfile = await apiCall(`/profiles/${profileId}`);
                updateProfileDisplay();
                saveToLocalStorage();
                await loadSources();
                await loadProfiles(); // Refresh the profile list to update selected state
                showMessage('Profile selected successfully!', 'success');
            } catch (error) {
                console.error('Failed to select profile:', error);
            }
        }

        async function deleteProfile(profileId) {
            if (!confirm('Are you sure you want to delete this profile?')) {
                return;
            }

            try {
                await apiCall(`/profiles/${profileId}`, { method: 'DELETE' });

                // If deleted profile was current, clear it
                if (currentProfile && currentProfile.id === profileId) {
                    currentProfile = null;
                    updateProfileDisplay();
                    saveToLocalStorage();
                    document.getElementById('sources-list').innerHTML = '<div class="loading">Select a profile to view sources</div>';
                }

                await loadProfiles();
                showMessage('Profile deleted successfully!', 'success');
            } catch (error) {
                console.error('Failed to delete profile:', error);
            }
        }

        async function loadSources() {
            if (!currentProfile) {
                document.getElementById('sources-list').innerHTML = '<div class="loading">Select a profile to view sources</div>';
                return;
            }

            try {
                const response = await apiCall(`/profiles/${currentProfile.id}/sources`);
                const sources = response.items || [];
                const sourcesList = document.getElementById('sources-list');

                if (sources.length === 0) {
                    sourcesList.innerHTML = '<div class="loading">No sources configured for this profile</div>';
                    return;
                }

                sourcesList.innerHTML = sources.map(source => `
                    <div class="source-item">
                        <div class="source-info">
                            <div class="source-name">${source.name}</div>
                            <div class="source-details">${source.parser_name} - ${source.link}</div>
                        </div>
                        <button onclick="deleteSource(${source.id})" style="background: #e74c3c;">Delete</button>
                    </div>
                `).join('');
            } catch (error) {
                document.getElementById('sources-list').innerHTML = '<div class="loading">Failed to load sources</div>';
            }
        }

        async function addSource(e) {
            e.preventDefault();

            if (!isAuthenticated) {
                showMessage('Please log in to add sources', 'error');
                return;
            }

            if (!currentProfile) {
                showMessage('Please select a profile first', 'error');
                return;
            }

            const sourceData = {
                name: document.getElementById('source-name').value,
                parser_name: document.getElementById('source-parser').value,
                link: document.getElementById('source-link').value
            };

            try {
                await apiCall(`/profiles/${currentProfile.id}/sources`, {
                    method: 'POST',
                    body: JSON.stringify(sourceData)
                });

                await loadSources();
                showMessage('Source added successfully!', 'success');
                document.getElementById('source-name').value = '';
                document.getElementById('source-link').value = '';
            } catch (error) {
                console.error('Failed to add source:', error);
            }
        }

        async function deleteSource(sourceId) {
            if (!confirm('Are you sure you want to delete this source?')) {
                return;
            }

            try {
                await apiCall(`/sources/${sourceId}`, { method: 'DELETE' });
                await loadSources();
                showMessage('Source deleted successfully!', 'success');
            } catch (error) {
                console.error('Failed to delete source:', error);
            }
        }

        async function createProfile(e) {
            e.preventDefault();

            if (!isAuthenticated) {
                showMessage('Please log in to create profiles', 'error');
                return;
            }

            const profileData = {
                name: document.getElementById('new-profile-name').value,
                description: document.getElementById('new-profile-description').value
            };

            try {
                const profile = await apiCall('/profiles', {
                    method: 'POST',
                    body: JSON.stringify(profileData)
                });

                await loadProfiles();
                showMessage('Profile created successfully!', 'success');
                document.getElementById('create-profile-form').reset();
            } catch (error) {
                console.error('Failed to create profile:', error);
            }
        }

        async function loadParsers() {
            try {
                const select = document.getElementById('source-parser');
                select.innerHTML = '<option value="">Loading parsers...</option>';

                // Make API call without authentication for parsers
                const response = await fetch('/api/parsers');
                if (!response.ok) {
                    throw new Error('Failed to fetch parsers');
                }
                parsers = await response.json();

                select.innerHTML = '<option value="">Select a parser...</option>';
                if (parsers && parsers.length > 0) {
                    parsers.forEach(parser => {
                        const option = document.createElement('option');
                        option.value = parser.name;
                        option.textContent = parser.name;
                        select.appendChild(option);
                    });
                    select.value = parsers[0].name;
                    updateParserInfo();
                } else {
                    select.innerHTML = '<option value="">No parsers available</option>';
                }
            } catch (error) {
                document.getElementById('source-parser').innerHTML = '<option value="">Failed to load parsers</option>';
            }
        }

        async function loadGroupers() {
            try {
                const select = document.getElementById('grouper-select');
                select.innerHTML = '<option value="">Loading groupers...</option>';

                // Make API call without authentication for groupers
                const response = await fetch('/api/groupers');
                if (!response.ok) {
                    throw new Error('Failed to fetch groupers');
                }
                groupers = await response.json();

                select.innerHTML = '<option value="">Select a grouper...</option>';
                if (groupers && groupers.length > 0) {
                    groupers.forEach(grouper => {
                        const option = document.createElement('option');
                        option.value = grouper.name;
                        option.textContent = grouper.name;
                        select.appendChild(option);
                    });
                    select.value = groupers[0].name;
                    updateGrouperInfo();
                } else {
                    select.innerHTML = '<option value="">No groupers available</option>';
                }
            } catch (error) {
                document.getElementById('grouper-select').innerHTML = '<option value="">Failed to load groupers</option>';
            }
        }

        function updateParserInfo() {
            const selectedParser = document.getElementById('source-parser').value;
            const descriptionElement = document.getElementById('parser-description');
            const hintElement = document.getElementById('parser-hint');

            if (selectedParser) {
                const parser = parsers.find(p => p.name === selectedParser);
                if (parser) {
                    if (parser.description) {
                        descriptionElement.textContent = parser.description;
                        descriptionElement.classList.add('visible');
                    } else {
                        descriptionElement.classList.remove('visible');
                    }
                    if (parser.link_hint) {
                        hintElement.textContent = `Hint: ${parser.link_hint}`;
                    } else {
                        hintElement.textContent = '';
                    }
                } else {
                    descriptionElement.classList.remove('visible');
                    hintElement.textContent = '';
                }
            } else {
                descriptionElement.classList.remove('visible');
                hintElement.textContent = '';
            }
        }

        function updateGrouperInfo() {
            const selectedGrouper = document.getElementById('grouper-select').value;
            const descriptionElement = document.getElementById('grouper-description');

            if (selectedGrouper) {
                const grouper = groupers.find(g => g.name === selectedGrouper);
                if (grouper && grouper.description) {
                    descriptionElement.textContent = grouper.description;
                    descriptionElement.classList.add('visible');
                } else {
                    descriptionElement.classList.remove('visible');
                }
            } else {
                descriptionElement.classList.remove('visible');
            }
        }

        function showMessage(message, type = 'error') {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = type;
            const messageText = document.createElement('span');
            messageText.textContent = message;
            const closeButton = document.createElement('button');
            closeButton.innerHTML = '&times;';
            closeButton.style.background = 'none';
            closeButton.style.border = 'none';
            closeButton.style.color = 'inherit';
            closeButton.style.float = 'right';
            closeButton.style.fontSize = '16px';
            closeButton.style.cursor = 'pointer';
            closeButton.style.padding = '0 5px';
            closeButton.style.marginLeft = '10px';
            closeButton.onclick = function() {
                messageDiv.remove();
            };
            messageDiv.appendChild(messageText);
            messageDiv.appendChild(closeButton);
            messagesDiv.appendChild(messageDiv);
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 5000);
        }

        async function fetchNews(e) {
            e.preventDefault();

            if (!isAuthenticated) {
                showMessage('Please log in to fetch news', 'error');
                return;
            }

            if (!currentProfile) {
                showMessage('Please select a profile first', 'error');
                return;
            }

            const grouper = document.getElementById('grouper-select').value;
            const fromDateTime = document.getElementById('from-datetime').value;
            const toDateTime = document.getElementById('to-datetime').value;

            if (!grouper) {
                showMessage('Please select a grouper', 'error');
                return;
            }

            const newsContent = document.getElementById('news-content');
            newsContent.innerHTML = '<div class="loading">Fetching news...</div>';

            try {
                const addTimezoneOffset = (dateTimeStr) => {
                    if (!dateTimeStr) return '';
                    const date = new Date(dateTimeStr);
                    const tzOffset = -date.getTimezoneOffset();
                    const tzOffsetHours = Math.floor(Math.abs(tzOffset) / 60);
                    const tzOffsetMinutes = Math.abs(tzOffset) % 60;
                    const tzOffsetStr = (tzOffset >= 0 ? '+' : '-') +
                                       String(tzOffsetHours).padStart(2, '0') + ':' +
                                       String(tzOffsetMinutes).padStart(2, '0');
                    return dateTimeStr + tzOffsetStr;
                };

                const params = new URLSearchParams({ grouper });
                if (fromDateTime) params.append('from_datetime', addTimezoneOffset(fromDateTime));
                if (toDateTime) params.append('to_datetime', addTimezoneOffset(toDateTime));

                const newsData = await apiCall(`/profiles/${currentProfile.id}/news?${params}`);
                newsPagination.combined = [];
                (newsData.post_groups || []).forEach((group, idx) => {
                    newsPagination.combined.push({ type: 'group', data: group, groupIndex: idx });
                });
                (newsData.posts || []).forEach(post => {
                    newsPagination.combined.push({ type: 'post', data: post });
                });
                newsPagination.page = 1;
                displayNewsPaginated();
                showMessage('News fetched successfully!', 'success');
            } catch (error) {
                newsContent.innerHTML = '<div class="error">Failed to fetch news</div>';
                console.error('Failed to fetch news:', error);
            }
        }

        // Enhanced pagination display
        function displayNewsPaginated() {
            const newsContent = document.getElementById('news-content');
            const { combined, page, perPage } = newsPagination;

            if (!combined.length) {
                newsContent.innerHTML = '<div class="loading">No news found</div>';
                return;
            }

            let html = '';
            const totalPages = Math.ceil(combined.length / perPage);
            const start = (page - 1) * perPage;
            const end = start + perPage;
            const itemsToShow = combined.slice(start, end);

            // Separate post groups and individual posts
            const postGroups = itemsToShow.filter(item => item.type === 'group');
            const individualPosts = itemsToShow.filter(item => item.type === 'post');

            // Calculate total articles
            const totalArticlesInGroups = combined.filter(item => item.type === 'group')
                .reduce((sum, item) => sum + item.data.posts.length, 0);
            const totalIndividualArticles = combined.filter(item => item.type === 'post').length;
            const totalArticles = totalArticlesInGroups + totalIndividualArticles;

            // Add stats bar
            html += `
                <div class="stats-bar">
                    <div class="stats-item">
                        <span class="number">${combined.filter(item => item.type === 'group').length}</span>
                        <span>Article Groups</span>
                    </div>
                    <div class="stats-item">
                        <span class="number">${totalIndividualArticles}</span>
                        <span>Individual Articles</span>
                    </div>
                    <div class="stats-item">
                        <span class="number">${totalArticles}</span>
                        <span>Total Articles</span>
                    </div>
                </div>
            `;

            // Pagination controls (top)
            if (totalPages > 1) {
                html += `<div class="pagination">
                    <button onclick="changeNewsPage(-1)" ${page === 1 ? 'disabled' : ''}>&laquo; Previous</button>
                    <span>Page ${page} of ${totalPages}</span>
                    <button onclick="changeNewsPage(1)" ${page === totalPages ? 'disabled' : ''}>Next &raquo;</button>
                </div>`;
            }

            // Post Groups Section
            if (postGroups.length > 0) {
                html += '<div class="section-divider">📚 Grouped Articles with AI Summaries</div>';
                postGroups.forEach((item) => {
                    let processedSummary = item.data.summary;
                    processedSummary = processedSummary.replace(/\[(\d+(?:,\s*\d+)*)\]/g, function(match, numbers) {
                        const refs = numbers.split(',').map(n => n.trim());
                        return refs.map(ref => `<a href="#" class="ref-link" data-ref="${ref}" data-group="${item.groupIndex}">[${ref}]</a>`).join('');
                    });

                    html += `
                        <div class="post-group">
                            <div class="post-group-summary"><strong>🤖 AI Summary:</strong> ${processedSummary}</div>
                            ${item.data.posts.map((post, postIndex) => {
                                const bodyId = `group-${item.groupIndex}-post-${postIndex}-body`;
                                const isLongText = post.body.length > 300;

                                return `
                                    <div class="post-item" id="group-${item.groupIndex}-post-${postIndex}">
                                        ${post.title ? `<div class="post-title">${post.title}</div>` : ''}
                                        ${post.author ? `<div class="post-author">👤 ${post.author}</div>` : ''}
                                        <div class="post-body ${isLongText ? 'collapsed' : ''}" id="${bodyId}">${post.body}</div>
                                        ${isLongText ? `<button class="expand-toggle" onclick="toggleExpand('${bodyId}', this)">Show more ▼</button>` : ''}
                                        <div class="post-meta">
                                            ${post.link ? `<div class="post-link"><a href="${post.link}" target="_blank">🔗 Read Original</a></div>` : '<div></div>'}
                                            ${post.published_time ? `<div class="post-time">📅 ${formatLocalTime(post.published_time)}</div>` : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                });
            }

            // Individual Posts Section
            if (individualPosts.length > 0) {
                html += '<div class="section-divider">📰 Individual Articles</div>';
                individualPosts.forEach((item, index) => {
                    const post = item.data;
                    const bodyId = `individual-post-${index}-body`;
                    const isLongText = post.body.length > 300;

                    html += `
                        <div class="individual-post">
                            ${post.title ? `<div class="post-title">${post.title}</div>` : ''}
                            ${post.author ? `<div class="post-author">👤 ${post.author}</div>` : ''}
                            <div class="post-body ${isLongText ? 'collapsed' : ''}" id="${bodyId}">${post.body}</div>
                            ${isLongText ? `<button class="expand-toggle" onclick="toggleExpand('${bodyId}', this)">Show more ▼</button>` : ''}
                            <div class="post-meta">
                                ${post.link ? `<div class="post-link"><a href="${post.link}" target="_blank">🔗 Read Original</a></div>` : '<div></div>'}
                                ${post.published_time ? `<div class="post-time">📅 ${formatLocalTime(post.published_time)}</div>` : ''}
                            </div>
                        </div>
                    `;
                });
            }

            // Pagination controls (bottom)
            if (totalPages > 1) {
                html += `<div class="pagination">
                    <button onclick="changeNewsPage(-1)" ${page === 1 ? 'disabled' : ''}>&laquo; Previous</button>
                    <span>Page ${page} of ${totalPages}</span>
                    <button onclick="changeNewsPage(1)" ${page === totalPages ? 'disabled' : ''}>Next &raquo;</button>
                </div>`;
            }

            newsContent.innerHTML = html;

            // Add enhanced event listeners for reference links
            document.querySelectorAll('.ref-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const ref = this.getAttribute('data-ref');
                    const groupIndex = this.getAttribute('data-group');

                    const postElement = document.getElementById(`group-${groupIndex}-post-${parseInt(ref) - 1}`);
                    if (postElement) {
                        smoothScrollTo(postElement, {
                            block: 'center',
                            duration: 1200,
                            easing: 'easeInOutCubic'
                        });

                        setTimeout(() => {
                            postElement.style.backgroundColor = '#fff3cd';
                            postElement.style.borderColor = '#ffc107';
                            postElement.style.boxShadow = '0 0 20px rgba(255, 193, 7, 0.3)';
                            postElement.style.transform = 'scale(1.02)';
                            postElement.style.transition = 'all 0.3s ease';

                            setTimeout(() => {
                                postElement.style.backgroundColor = '';
                                postElement.style.borderColor = '#e2e8f0';
                                postElement.style.boxShadow = '';
                                postElement.style.transform = '';
                            }, 3000);
                        }, 600);
                    }
                });
            });
        }

        // Enhanced smooth scrolling function
        function smoothScrollTo(element, options = {}) {
            if (!element) return;

            const defaultOptions = {
                block: 'center',
                duration: 1000,
                easing: 'easeInOutCubic'
            };

            const scrollOptions = { ...defaultOptions, ...options };
            const targetRect = element.getBoundingClientRect();
            const startY = window.pageYOffset;

            let targetY;
            switch (scrollOptions.block) {
                case 'start':
                    targetY = targetRect.top + startY - 20;
                    break;
                case 'center':
                    targetY = targetRect.top + startY - (window.innerHeight / 2) + (targetRect.height / 2);
                    break;
                case 'end':
                    targetY = targetRect.top + startY - window.innerHeight + targetRect.height + 20;
                    break;
                default:
                    targetY = targetRect.top + startY - (window.innerHeight / 2);
            }

            const distance = targetY - startY;
            const duration = scrollOptions.duration;
            let startTime = null;

            const easingFunctions = {
                easeInOutCubic: (t) => t < 0.5 ? 4 * t * t * t : (t - 1) * (2 * t - 2) * (2 * t - 2) + 1,
                easeOutQuart: (t) => 1 - (--t) * t * t * t,
                easeInOutQuart: (t) => t < 0.5 ? 8 * t * t * t * t : 1 - 8 * (--t) * t * t * t
            };

            const easeFunction = easingFunctions[scrollOptions.easing] || easingFunctions.easeInOutCubic;

            function animate(currentTime) {
                if (startTime === null) startTime = currentTime;
                const timeElapsed = currentTime - startTime;
                const progress = Math.min(timeElapsed / duration, 1);
                const ease = easeFunction(progress);

                const currentY = startY + distance * ease;
                window.scrollTo(0, currentY);

                if (timeElapsed < duration) {
                    requestAnimationFrame(animate);
                }
            }

            if (Math.abs(distance) > 10) {
                requestAnimationFrame(animate);
            }
        }

        function changeNewsPage(direction) {
            const { combined, page, perPage } = newsPagination;
            const totalPages = Math.ceil(combined.length / perPage);

            if (direction === 1 && page < totalPages) {
                newsPagination.page += 1;
            } else if (direction === -1 && page > 1) {
                newsPagination.page -= 1;
            }

            displayNewsPaginated();

            setTimeout(() => {
                const newsContentElement = document.getElementById('news-content');
                if (newsContentElement) {
                    smoothScrollTo(newsContentElement, {
                        block: 'start',
                        duration: 800,
                        easing: 'easeOutQuart'
                    });
                }
            }, 50);
        }

        function toggleExpand(bodyId, button) {
            const bodyElement = document.getElementById(bodyId);
            const isCollapsed = bodyElement.classList.contains('collapsed');

            if (isCollapsed) {
                bodyElement.classList.remove('collapsed');
                button.innerHTML = 'Show less ▲';
            } else {
                bodyElement.classList.add('collapsed');
                button.innerHTML = 'Show more ▼';
                setTimeout(() => {
                    const targetElement = bodyElement.closest('.post-item') || bodyElement;
                    if (targetElement) {
                        smoothScrollTo(targetElement, {
                            block: 'center',
                            duration: 600,
                            easing: 'easeInOutQuart'
                        });
                    }
                }, 350);
            }
        }
    </script>
</body>
</html>
