<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News Grouper</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth !important;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: row;
            min-height: 100vh;
            padding: 0;
            margin: 0;
            scroll-behavior: smooth !important;
        }

        /* Add smooth scrolling to all scrollable elements */
        * {
            scroll-behavior: smooth !important;
        }

        /* Ensure smooth scrolling works on all browsers */
        html, body, .sidebar, .main-content, .container, .news-content {
            scroll-behavior: smooth !important;
        }

        .sidebar {
            width: 280px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            padding: 30px 24px;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            display: flex;
            flex-direction: column;
            gap: 24px;
            box-shadow: 2px 0 16px rgba(102, 126, 234, 0.15);
            z-index: 100;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        .sidebar h1 {
            font-size: 1.8em;
            margin-bottom: 20px;
            color: #fff;
            text-align: left;
            font-weight: 600;
        }

        .sidebar nav {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .sidebar nav a {
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            font-weight: 500;
            font-size: 1em;
            padding: 12px 16px;
            border-radius: 8px;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            cursor: pointer;
            display: block;
        }

        .sidebar nav a.active,
        .sidebar nav a:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
            border-color: rgba(255, 255, 255, 0.2);
        }

        .sidebar .profile-info {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            padding: 16px;
            border-radius: 12px;
            font-size: 0.9em;
            margin-top: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .main-content {
            flex: 1;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin-left: 280px;
            display: flex;
            align-items: center;
            justify-content: center;
            scroll-behavior: smooth;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08);
            backdrop-filter: blur(10px);
            margin: 20px 0;
            scroll-behavior: smooth;
        }

        .section-divider {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            padding: 20px 32px;
            margin: 48px 0 32px 0;
            border-radius: 16px;
            font-weight: 600;
            font-size: 1.2em;
            text-align: center;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.25);
            position: relative;
        }

        .section-divider::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 18px;
            z-index: -1;
            opacity: 0.3;
        }

        #messages {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
        }

        #messages .error,
        #messages .success {
            padding: 16px 20px;
            margin-bottom: 12px;
            border-radius: 8px;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #messages .error {
            background: #fee;
            color: #c53030;
            border: 1px solid #feb2b2;
        }

        #messages .success {
            background: #f0fff4;
            color: #38a169;
            border: 1px solid #9ae6b4;
        }

        .section {
            margin-bottom: 32px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(102, 126, 234, 0.1);
            overflow: hidden;
            display: none;
        }

        .section.active {
            display: block;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            background: rgba(102, 126, 234, 0.05);
            border-bottom: 1px solid rgba(102, 126, 234, 0.1);
        }

        .section-header h2 {
            color: #2d3748;
            font-size: 1.25em;
            margin: 0;
            font-weight: 600;
        }

        .section-content {
            padding: 24px;
        }

        .fetch-news-section {
            background: rgba(102, 126, 234, 0.05);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .fetch-news-section h3 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.1em;
            font-weight: 600;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
        }

        .form-section {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .form-section h3 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.1em;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 500;
            font-size: 0.95em;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.95em;
            transition: all 0.2s ease;
            background: #fff;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group small {
            color: #718096;
            font-size: 0.85em;
            margin-top: 4px;
            display: block;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .datetime-group {
            display: flex;
            gap: 16px;
        }

        .datetime-group .form-group {
            flex: 1;
        }

        .file-input-wrapper {
            position: relative;
            display: block;
            width: 100%;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-display {
            background: #f8f9fa;
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #4a5568;
        }

        .file-input-display:hover {
            background: rgba(102, 126, 234, 0.05);
            border-color: #667eea;
        }

        .sources-list {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(102, 126, 234, 0.1);
            max-height: 400px;
            overflow-y: auto;
        }

        .source-item {
            background: #f8f9fa;
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        .source-item:hover {
            background: #f1f5f9;
            border-color: #cbd5e0;
        }

        .source-item:last-child {
            margin-bottom: 0;
        }

        .source-info {
            flex: 1;
        }

        .source-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .source-details {
            color: #718096;
            font-size: 0.9em;
        }

        .source-item button {
            background: #e53e3e;
            padding: 8px 16px;
            font-size: 0.85em;
            margin-left: 12px;
        }

        .source-item button:hover {
            background: #c53030;
        }

        .news-content {
            background: transparent;
            border-radius: 0;
            padding: 0;
            box-shadow: none;
            border: none;
            max-height: none;
            overflow: visible;
            scroll-behavior: smooth;
        }

        .post-group {
            background: #fff;
            border-radius: 16px;
            padding: 28px;
            margin-bottom: 32px;
            border: 1px solid rgba(102, 126, 234, 0.15);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .post-group:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .post-group::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .post-group-summary {
            font-weight: 500;
            color: #2d3748;
            margin-bottom: 24px;
            font-size: 1.1em;
            line-height: 1.7;
            padding: 20px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.08), rgba(118, 75, 162, 0.08));
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }

        .post-item {
            background: #f8f9fa;
            padding: 20px;
            margin-bottom: 16px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
            position: relative;
        }

        .post-item:hover {
            border-color: #cbd5e0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transform: translateY(-1px);
        }

        .post-item:last-child {
            margin-bottom: 0;
        }

        .post-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 12px;
            font-size: 1.15em;
            line-height: 1.4;
        }

        .post-author {
            color: #667eea;
            font-size: 0.9em;
            margin-bottom: 12px;
            font-weight: 500;
        }

        .post-body {
            color: #4a5568;
            line-height: 1.7;
            margin-bottom: 16px;
            font-size: 0.95em;
            white-space: pre-wrap;
        }

        .post-body.collapsed {
            max-height: 120px;
            overflow: hidden;
            position: relative;
        }

        .post-body.collapsed::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40px;
            background: linear-gradient(transparent, #f8f9fa);
        }

        .expand-toggle {
            background: none;
            border: none;
            color: #667eea;
            font-weight: 500;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 8px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .expand-toggle:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: none;
            box-shadow: none;
        }

        .post-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e2e8f0;
        }

        .post-link a {
            color: #667eea;
            text-decoration: none;
            font-size: 0.9em;
            font-weight: 500;
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }

        .post-link a:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: #667eea;
            text-decoration: none;
        }

        .post-time {
            color: #a0aec0;
            font-size: 0.85em;
            font-weight: 500;
        }

        .individual-post {
            background: #fff;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid rgba(102, 126, 234, 0.15);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }

        .individual-post:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .individual-post .post-title {
            font-size: 1.25em;
            margin-bottom: 16px;
            color: #2d3748;
        }

        .individual-post .post-body {
            font-size: 1em;
            line-height: 1.7;
            color: #4a5568;
        }

        .pagination {
            text-align: center;
            margin: 48px 0;
            padding: 24px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            border: 1px solid rgba(102, 126, 234, 0.1);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
        }

        .pagination button {
            margin: 0 12px;
            padding: 12px 24px;
            font-size: 0.95em;
            border-radius: 8px;
        }

        .pagination span {
            color: #4a5568;
            font-weight: 600;
            font-size: 1em;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
            font-size: 1.1em;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .stats-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            margin-bottom: 24px;
            border: 1px solid rgba(102, 126, 234, 0.1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .stats-item {
            text-align: center;
            color: #4a5568;
            font-size: 0.9em;
        }

        .stats-item .number {
            font-size: 1.5em;
            font-weight: 600;
            color: #667eea;
            display: block;
        }

        .ref-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
            padding: 2px 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
            display: inline;
            margin: 0 1px;
            font-size: 0.95em;
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .ref-link:hover {
            background: rgba(102, 126, 234, 0.2);
            text-decoration: none;
            transform: none;
            box-shadow: none;
        }

        .algorithm-description {
            margin-top: 8px;
            padding: 12px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 6px;
            border: 1px solid rgba(102, 126, 234, 0.1);
            color: #4a5568;
            font-size: 0.9em;
            line-height: 1.5;
            display: none;
        }

        .algorithm-description.visible {
            display: block;
        }

        @media (max-width: 1200px) {
            .sidebar {
                width: 240px;
                padding: 20px 16px;
            }

            .container {
                padding: 24px;
            }
        }

        @media (max-width: 900px) {
            .grid {
                grid-template-columns: 1fr;
                gap: 24px;
            }

            .main-content {
                padding: 12px;
            }

            .container {
                padding: 20px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: static;
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
                padding: 16px;
            }

            .sidebar h1 {
                font-size: 1.5em;
                margin-bottom: 0;
            }

            .sidebar nav {
                flex-direction: row;
                gap: 8px;
            }

            .sidebar nav a {
                padding: 8px 12px;
                font-size: 0.9em;
            }

            .sidebar .profile-info {
                display: none;
            }

            .main-content {
                margin-left: 0;
                padding: 8px;
                align-items: stretch;
            }

            .container {
                padding: 20px;
                margin: 0;
            }

            .section-divider {
                margin: 20px -20px 16px -20px;
                padding: 12px 20px;
                font-size: 1em;
            }

            .section-content {
                padding: 16px;
            }

            .form-section {
                padding: 16px;
            }

            .datetime-group {
                flex-direction: column;
                gap: 12px;
            }

            #messages {
                position: static;
                margin-bottom: 16px;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h1>News Grouper</h1>
        <nav>
            <a href="#" data-tab="profile-section" class="active">Profile</a>
            <a href="#" data-tab="sources-section">Sources</a>
            <a href="#" data-tab="news-section">Fetch News</a>
        </nav>
        <div id="current-profile" class="profile-info" style="display: none;">
            <strong>Current Profile:</strong> <span id="profile-name"></span><br>
            <span id="profile-description"></span>
        </div>
    </div>

    <div class="main-content">
        <div id="messages"></div>

        <div class="container">
            <!-- Profile Management -->
            <div class="section active" id="profile-section">
                <div class="section-header">
                    <h2>Profile Management</h2>
                </div>
                <div class="section-content">
                    <div class="grid">
                        <div class="form-section">
                            <h3>Create New Profile</h3>
                            <form id="create-profile-form">
                                <div class="form-group">
                                    <label for="new-profile-name">Name:</label>
                                    <input type="text" id="new-profile-name" required>
                                </div>
                                <div class="form-group">
                                    <label for="new-profile-description">Description:</label>
                                    <textarea id="new-profile-description" rows="3"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="new-profile-path">Save File Path:</label>
                                    <input type="text" id="new-profile-path" placeholder="e.g., /path/to/profile.json" required>
                                    <small>Enter the full path where you want to save this profile. Browser security prevents using a file save dialog.</small>
                                </div>
                                <button type="submit">Create Profile</button>
                            </form>
                        </div>

                        <div class="form-section">
                            <h3>Load Existing Profile</h3>
                            <form onsubmit="loadProfile();return false;">
                                <div class="form-group">
                                    <label>Select Profile File:</label>
                                    <div class="file-input-wrapper">
                                        <input type="file" id="profile-file" class="file-input" accept=".json">
                                        <div class="file-input-display">
                                            <span id="file-display-text">Click to select profile file</span>
                                        </div>
                                    </div>
                                </div>
                                <button id="load-profile-btn" type="submit">Load Profile</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- News Sources Management -->
            <div class="section" id="sources-section">
                <div class="section-header">
                    <h2>News Sources</h2>
                </div>
                <div class="section-content">
                    <div class="grid">
                        <div class="form-section">
                            <h3>Add New Source</h3>
                            <form id="add-source-form">
                                <div class="form-group">
                                    <label for="source-name">Name:</label>
                                    <input type="text" id="source-name" required>
                                </div>
                                <div class="form-group">
                                    <label for="source-parser">Parser:</label>
                                    <select id="source-parser" required>
                                        <option value="">Select a parser...</option>
                                    </select>
                                    <div id="parser-description" class="algorithm-description"></div>
                                </div>
                                <div class="form-group">
                                    <label for="source-link">Link:</label>
                                    <input type="text" id="source-link" required>
                                    <small id="parser-hint"></small>
                                </div>
                                <button type="submit">Add Source</button>
                            </form>
                        </div>

                        <div>
                            <h3 style="margin-bottom: 16px; color: #2d3748; font-size: 1.1em; font-weight: 600;">Current Sources</h3>
                            <div id="sources-list" class="sources-list">
                                <div class="loading">No profile loaded</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- News Fetching & Display Combined -->
            <div class="section" id="news-section">
                <div class="section-header">
                    <h2>Fetch News</h2>
                </div>
                <div class="section-content">
                    <!-- Fetch News Form -->
                    <div class="fetch-news-section">
                        <h3>Fetch News</h3>
                        <form id="fetch-news-form">
                            <div class="form-group">
                                <label for="grouper-select">Grouper:</label>
                                <select id="grouper-select" required>
                                    <option value="">Select a grouper...</option>
                                </select>
                                <div id="grouper-description" class="algorithm-description"></div>
                            </div>
                            <div class="datetime-group">
                                <div class="form-group">
                                    <label for="from-datetime">From Date:</label>
                                    <input type="datetime-local" id="from-datetime" required>
                                </div>
                                <div class="form-group">
                                    <label for="to-datetime">To Date:</label>
                                    <input type="datetime-local" id="to-datetime">
                                </div>
                            </div>
                            <button type="submit">Fetch News</button>
                        </form>
                    </div>

                    <!-- News Display -->
                    <div>
                        <h3 style="margin-bottom: 16px; color: #2d3748; font-size: 1.1em; font-weight: 600;">News Content</h3>
                        <div id="news-content" class="news-content">
                            <div class="loading">Fetch news to see content here</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentProfile = null;
        let parsers = [];
        let groupers = [];

        // Pagination state for unified list
        let newsPagination = {
            combined: [],
            page: 1,
            perPage: 5
        };

        // Function to convert server time to local timezone
        function formatLocalTime(timeString) {
            if (!timeString) return '';

            // Parse the server-provided time string
            const date = new Date(timeString);

            // Check if the date is valid
            if (isNaN(date.getTime())) {
                return timeString; // Return original string if parsing fails
            }

            // Format the date in the client's local timezone
            return date.toLocaleString();
        }

        // Tab switching functionality
        function switchTab(tabId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });

            // Show selected section
            document.getElementById(tabId).classList.add('active');

            // Update active nav link
            document.querySelectorAll('.sidebar nav a').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            loadParsers();
            loadGroupers();
            setupEventListeners();
            checkCurrentProfile();
        });

        async function checkCurrentProfile() {
            try {
                currentProfile = await apiCall('/current-profile');
                updateProfileDisplay();
                loadSources();
                showMessage('Profile loaded successfully!', 'success');
            } catch (error) {
                // No profile is loaded, that's okay
                console.log('No profile currently loaded');
            }
        }

        function setupEventListeners() {
            // Tab navigation
            document.querySelectorAll('.sidebar nav a').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const tabId = this.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });

            // Profile creation
            document.getElementById('create-profile-form').addEventListener('submit', createProfile);

            // Source management
            document.getElementById('add-source-form').addEventListener('submit', addSource);
            document.getElementById('source-parser').addEventListener('change', updateParserInfo);

            // News fetching
            document.getElementById('fetch-news-form').addEventListener('submit', fetchNews);
            document.getElementById('grouper-select').addEventListener('change', updateGrouperInfo);

            // File input
            document.getElementById('profile-file').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    document.getElementById('file-display-text').textContent = file.name;
                }
            });
        }

        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(`/api${endpoint}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'API request failed');
                }

                // Handle empty responses (common for DELETE operations)
                const text = await response.text();
                if (!text) {
                    return {}; // Return empty object for successful empty responses
                }

                return JSON.parse(text);
            } catch (error) {
                showMessage(error.message, 'error');
                throw error;
            }
        }

        function showMessage(message, type = 'error') {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = type;

            // Create message text element
            const messageText = document.createElement('span');
            messageText.textContent = message;

            // Create close button
            const closeButton = document.createElement('button');
            closeButton.innerHTML = '&times;';
            closeButton.style.background = 'none';
            closeButton.style.border = 'none';
            closeButton.style.color = 'inherit';
            closeButton.style.float = 'right';
            closeButton.style.fontSize = '16px';
            closeButton.style.cursor = 'pointer';
            closeButton.style.padding = '0 5px';
            closeButton.style.marginLeft = '10px';
            closeButton.onclick = function() {
                messageDiv.remove();
            };

            // Append elements to message div
            messageDiv.appendChild(messageText);
            messageDiv.appendChild(closeButton);

            // Add to messages container
            messagesDiv.appendChild(messageDiv);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 5000);
        }

        async function loadParsers() {
            try {
                const select = document.getElementById('source-parser');
                select.innerHTML = '<option value="">Loading parsers...</option>';

                parsers = await apiCall('/parsers');

                select.innerHTML = '<option value="">Select a parser...</option>';
                if (parsers && parsers.length > 0) {
                    parsers.forEach(parser => {
                        const option = document.createElement('option');
                        option.value = parser.name;
                        option.textContent = parser.name;
                        select.appendChild(option);
                    });

                    // Select first parser by default
                    select.value = parsers[0].name;
                    updateParserInfo();
                } else {
                    select.innerHTML = '<option value="">No parsers available</option>';
                    showMessage('No parsers available', 'error');
                }
            } catch (error) {
                console.error('Failed to load parsers:', error);
                document.getElementById('source-parser').innerHTML = '<option value="">Failed to load parsers</option>';
                showMessage('Failed to load parsers: ' + error.message, 'error');
            }
        }

        async function loadGroupers() {
            try {
                const select = document.getElementById('grouper-select');
                select.innerHTML = '<option value="">Loading groupers...</option>';

                groupers = await apiCall('/groupers');

                select.innerHTML = '<option value="">Select a grouper...</option>';
                if (groupers && groupers.length > 0) {
                    groupers.forEach(grouper => {
                        const option = document.createElement('option');
                        option.value = grouper.name;
                        option.textContent = grouper.name;
                        select.appendChild(option);
                    });

                    // Select first grouper by default
                    select.value = groupers[0].name;
                    updateGrouperInfo();
                } else {
                    select.innerHTML = '<option value="">No groupers available</option>';
                    showMessage('No groupers available', 'error');
                }
            } catch (error) {
                console.error('Failed to load groupers:', error);
                document.getElementById('grouper-select').innerHTML = '<option value="">Failed to load groupers</option>';
                showMessage('Failed to load groupers: ' + error.message, 'error');
            }
        }

        function updateParserInfo() {
            const selectedParser = document.getElementById('source-parser').value;
            const descriptionElement = document.getElementById('parser-description');
            const hintElement = document.getElementById('parser-hint');

            if (selectedParser) {
                const parser = parsers.find(p => p.name === selectedParser);
                if (parser) {
                    // Show description
                    if (parser.description) {
                        descriptionElement.textContent = parser.description;
                        descriptionElement.classList.add('visible');
                    } else {
                        descriptionElement.classList.remove('visible');
                    }

                    // Show hint
                    if (parser.link_hint) {
                        hintElement.textContent = `Hint: ${parser.link_hint}`;
                    } else {
                        hintElement.textContent = '';
                    }
                } else {
                    descriptionElement.classList.remove('visible');
                    hintElement.textContent = '';
                }
            } else {
                descriptionElement.classList.remove('visible');
                hintElement.textContent = '';
            }
        }

        function updateGrouperInfo() {
            const selectedGrouper = document.getElementById('grouper-select').value;
            const descriptionElement = document.getElementById('grouper-description');

            if (selectedGrouper) {
                const grouper = groupers.find(g => g.name === selectedGrouper);
                if (grouper && grouper.description) {
                    descriptionElement.textContent = grouper.description;
                    descriptionElement.classList.add('visible');
                } else {
                    descriptionElement.classList.remove('visible');
                }
            } else {
                descriptionElement.classList.remove('visible');
            }
        }

        async function createProfile(e) {
            e.preventDefault(); // This prevents the default form submission

            const profileData = {
                name: document.getElementById('new-profile-name').value,
                description: document.getElementById('new-profile-description').value,
                file_path: document.getElementById('new-profile-path').value
            };

            try {
                const profile = await apiCall('/profiles', {
                    method: 'POST',
                    body: JSON.stringify(profileData)
                });

                currentProfile = profile;
                updateProfileDisplay();
                loadSources();
                showMessage('Profile created successfully!', 'success');
                document.getElementById('create-profile-form').reset();
            } catch (error) {
                console.error('Failed to create profile:', error);
                showMessage('Failed to create profile: ' + error.message, 'error');
            }

            return false; // Ensure no form submission occurs
        }

        async function loadProfile() {
            const fileInput = document.getElementById('profile-file');
            const file = fileInput.files[0];

            if (!file) {
                showMessage('Please select a profile file', 'error');
                return;
            }

            try {
                const profile = await apiCall('/current-profile', {
                    method: 'POST',
                    body: JSON.stringify({ profile_path: file.name })
                });

                currentProfile = profile;
                updateProfileDisplay();
                loadSources();
                showMessage('Profile loaded successfully!', 'success');
            } catch (error) {
                console.error('Failed to load profile:', error);
            }
        }

        function updateProfileDisplay() {
            if (currentProfile) {
                document.getElementById('current-profile').style.display = 'block';
                document.getElementById('profile-name').textContent = currentProfile.name;
                document.getElementById('profile-description').textContent = currentProfile.description || '';
            } else {
                document.getElementById('current-profile').style.display = 'none';
            }
        }

        async function loadSources() {
            try {
                const sources = await apiCall('/sources');
                const sourcesList = document.getElementById('sources-list');

                if (sources.length === 0) {
                    sourcesList.innerHTML = '<div class="loading">No sources configured</div>';
                    return;
                }

                sourcesList.innerHTML = sources.map(source => `
                    <div class="source-item">
                        <div class="source-info">
                            <div class="source-name">${source.name}</div>
                            <div class="source-details">${source.parser_name} - ${source.link}</div>
                        </div>
                        <button onclick="deleteSource(${source.id})" style="background: #e74c3c;">Delete</button>
                    </div>
                `).join('');
            } catch (error) {
                document.getElementById('sources-list').innerHTML = '<div class="loading">No profile loaded</div>';
            }
        }

        async function addSource(e) {
            e.preventDefault();

            if (!currentProfile) {
                showMessage('Please load a profile first', 'error');
                return;
            }

            const sourceData = {
                name: document.getElementById('source-name').value,
                parser_name: document.getElementById('source-parser').value,
                link: document.getElementById('source-link').value
            };

            try {
                await apiCall('/sources', {
                    method: 'POST',
                    body: JSON.stringify(sourceData)
                });

                loadSources();
                showMessage('Source added successfully!', 'success');
                // Clear only name and link fields, preserve parser selection
                document.getElementById('source-name').value = '';
                document.getElementById('source-link').value = '';
                document.getElementById('parser-hint').textContent = '';
            } catch (error) {
                console.error('Failed to add source:', error);
            }
        }

        async function deleteSource(sourceId) {
            if (!confirm('Are you sure you want to delete this source?')) {
                return;
            }

            try {
                await apiCall(`/sources/${sourceId}`, {
                    method: 'DELETE'
                });

                loadSources();
                showMessage('Source deleted successfully!', 'success');
            } catch (error) {
                console.error('Failed to delete source:', error);
                // Still refresh the sources list in case the deletion actually worked
                loadSources();
            }
        }

        async function fetchNews(e) {
            e.preventDefault();

            if (!currentProfile) {
                showMessage('Please load a profile first', 'error');
                return;
            }

            const grouper = document.getElementById('grouper-select').value;
            const fromDateTime = document.getElementById('from-datetime').value;
            const toDateTime = document.getElementById('to-datetime').value;

            if (!grouper) {
                showMessage('Please select a grouper', 'error');
                return;
            }

            const newsContent = document.getElementById('news-content');
            newsContent.innerHTML = '<div class="loading">Fetching news...</div>';

            try {
                // Add timezone offset to datetime values
                const addTimezoneOffset = (dateTimeStr) => {
                    if (!dateTimeStr) return '';
                    // Create a Date object from the datetime-local value
                    const date = new Date(dateTimeStr);
                    // Get timezone offset in minutes and convert to hours:minutes format
                    const tzOffset = -date.getTimezoneOffset();
                    const tzOffsetHours = Math.floor(Math.abs(tzOffset) / 60);
                    const tzOffsetMinutes = Math.abs(tzOffset) % 60;
                    const tzOffsetStr = (tzOffset >= 0 ? '+' : '-') +
                                       String(tzOffsetHours).padStart(2, '0') + ':' +
                                       String(tzOffsetMinutes).padStart(2, '0');
                    // Return ISO string with timezone offset
                    return dateTimeStr + tzOffsetStr;
                };

                const params = new URLSearchParams({ grouper });
                if (fromDateTime) params.append('from_datetime', addTimezoneOffset(fromDateTime));
                if (toDateTime) params.append('to_datetime', addTimezoneOffset(toDateTime));

                const newsData = await apiCall(`/news?${params}`);
                // Combine post groups and posts into a single list
                newsPagination.combined = [];
                (newsData.post_groups || []).forEach((group, idx) => {
                    newsPagination.combined.push({ type: 'group', data: group, groupIndex: idx });
                });
                (newsData.posts || []).forEach(post => {
                    newsPagination.combined.push({ type: 'post', data: post });
                });
                newsPagination.page = 1;
                displayNewsPaginated();
                showMessage('News fetched successfully!', 'success');
                // Don't reset the form - preserve all selections
            } catch (error) {
                newsContent.innerHTML = '<div class="error">Failed to fetch news</div>';
                console.error('Failed to fetch news:', error);
            }
        }

        // Enhanced pagination display
        function displayNewsPaginated() {
            const newsContent = document.getElementById('news-content');
            const { combined, page, perPage } = newsPagination;

            if (!combined.length) {
                newsContent.innerHTML = '<div class="loading">No news found</div>';
                return;
            }

            let html = '';
            const totalPages = Math.ceil(combined.length / perPage);
            const start = (page - 1) * perPage;
            const end = start + perPage;
            const itemsToShow = combined.slice(start, end);

            // Separate post groups and individual posts
            const postGroups = itemsToShow.filter(item => item.type === 'group');
            const individualPosts = itemsToShow.filter(item => item.type === 'post');

            // Calculate total articles (articles within groups + individual articles)
            const totalArticlesInGroups = combined.filter(item => item.type === 'group')
                .reduce((sum, item) => sum + item.data.posts.length, 0);
            const totalIndividualArticles = combined.filter(item => item.type === 'post').length;
            const totalArticles = totalArticlesInGroups + totalIndividualArticles;

            // Add stats bar
            html += `
                <div class="stats-bar">
                    <div class="stats-item">
                        <span class="number">${combined.filter(item => item.type === 'group').length}</span>
                        <span>Article Groups</span>
                    </div>
                    <div class="stats-item">
                        <span class="number">${totalIndividualArticles}</span>
                        <span>Individual Articles</span>
                    </div>
                    <div class="stats-item">
                        <span class="number">${totalArticles}</span>
                        <span>Total Articles</span>
                    </div>
                </div>
            `;

            // Pagination controls (top)
            if (totalPages > 1) {
                html += `<div class="pagination">
                    <button onclick="changeNewsPage(-1)" ${page === 1 ? 'disabled' : ''}>&laquo; Previous</button>
                    <span>Page ${page} of ${totalPages}</span>
                    <button onclick="changeNewsPage(1)" ${page === totalPages ? 'disabled' : ''}>Next &raquo;</button>
                </div>`;
            }

            // Post Groups Section
            if (postGroups.length > 0) {
                html += '<div class="section-divider">ðŸ“š Grouped Articles with AI Summaries</div>';
                postGroups.forEach((item) => {
                    let processedSummary = item.data.summary;
                    processedSummary = processedSummary.replace(/\[(\d+(?:,\s*\d+)*)\]/g, function(match, numbers) {
                        const refs = numbers.split(',').map(n => n.trim());
                        return refs.map(ref => `<a href="#" class="ref-link" data-ref="${ref}" data-group="${item.groupIndex}">[${ref}]</a>`).join('');
                    });

                    html += `
                        <div class="post-group">
                            <div class="post-group-summary"><strong>ðŸ¤– AI Summary:</strong> ${processedSummary}</div>
                            ${item.data.posts.map((post, postIndex) => {
                                const bodyId = `group-${item.groupIndex}-post-${postIndex}-body`;
                                const isLongText = post.body.length > 300;

                                return `
                                    <div class="post-item" id="group-${item.groupIndex}-post-${postIndex}">
                                        ${post.title ? `<div class="post-title">${post.title}</div>` : ''}
                                        ${post.author ? `<div class="post-author">ðŸ‘¤ ${post.author}</div>` : ''}
                                        <div class="post-body ${isLongText ? 'collapsed' : ''}" id="${bodyId}">${post.body}</div>
                                        ${isLongText ? `<button class="expand-toggle" onclick="toggleExpand('${bodyId}', this)">Show more â–¼</button>` : ''}
                                        <div class="post-meta">
                                            ${post.link ? `<div class="post-link"><a href="${post.link}" target="_blank">ðŸ”— Read Original</a></div>` : '<div></div>'}
                                            ${post.published_time ? `<div class="post-time">ðŸ“… ${formatLocalTime(post.published_time)}</div>` : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                });
            }

            // Individual Posts Section
            if (individualPosts.length > 0) {
                html += '<div class="section-divider">ðŸ“° Individual Articles</div>';
                individualPosts.forEach((item, index) => {
                    const post = item.data;
                    const bodyId = `individual-post-${index}-body`;
                    const isLongText = post.body.length > 300;

                    html += `
                        <div class="individual-post">
                            ${post.title ? `<div class="post-title">${post.title}</div>` : ''}
                            ${post.author ? `<div class="post-author">ðŸ‘¤ ${post.author}</div>` : ''}
                            <div class="post-body ${isLongText ? 'collapsed' : ''}" id="${bodyId}">${post.body}</div>
                            ${isLongText ? `<button class="expand-toggle" onclick="toggleExpand('${bodyId}', this)">Show more â–¼</button>` : ''}
                            <div class="post-meta">
                                ${post.link ? `<div class="post-link"><a href="${post.link}" target="_blank">ðŸ”— Read Original</a></div>` : '<div></div>'}
                                ${post.published_time ? `<div class="post-time">ðŸ“… ${formatLocalTime(post.published_time)}</div>` : ''}
                            </div>
                        </div>
                    `;
                });
            }

            // Pagination controls (bottom)
            if (totalPages > 1) {
                html += `<div class="pagination">
                    <button onclick="changeNewsPage(-1)" ${page === 1 ? 'disabled' : ''}>&laquo; Previous</button>
                    <span>Page ${page} of ${totalPages}</span>
                    <button onclick="changeNewsPage(1)" ${page === totalPages ? 'disabled' : ''}>Next &raquo;</button>
                </div>`;
            }

            newsContent.innerHTML = html;

            // Add event listeners for reference links
            document.querySelectorAll('.ref-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const ref = this.getAttribute('data-ref');
                    const groupIndex = this.getAttribute('data-group');

                    const postElement = document.getElementById(`group-${groupIndex}-post-${parseInt(ref) - 1}`);
                    if (postElement) {
                        // Use enhanced smooth scrolling
                        smoothScrollTo(postElement, { behavior: 'smooth', block: 'center' });

                        // Add highlight effect
                        postElement.style.backgroundColor = '#fff3cd';
                        postElement.style.borderColor = '#ffc107';
                        postElement.style.boxShadow = '0 0 20px rgba(255, 193, 7, 0.3)';
                        postElement.style.transition = 'all 0.3s ease';

                        setTimeout(() => {
                            postElement.style.backgroundColor = '';
                            postElement.style.borderColor = '#e2e8f0';
                            postElement.style.boxShadow = '';
                        }, 3000);
                    }
                });
            });
        }

        // Enhanced smooth scrolling function with fallbacks
        function smoothScrollTo(element, options = {}) {
            const defaultOptions = {
                behavior: 'smooth',
                block: 'center',
                inline: 'nearest'
            };

            const scrollOptions = { ...defaultOptions, ...options };

            try {
                // Try modern smooth scrolling first
                element.scrollIntoView(scrollOptions);
            } catch (error) {
                // Fallback for older browsers
                try {
                    element.scrollIntoView(true);

                    // Manual smooth scroll animation as fallback
                    const targetY = element.getBoundingClientRect().top + window.pageYOffset - (window.innerHeight / 2);
                    const startY = window.pageYOffset;
                    const distance = targetY - startY;
                    const duration = 800;
                    let startTime = null;

                    function animate(currentTime) {
                        if (startTime === null) startTime = currentTime;
                        const timeElapsed = currentTime - startTime;
                        const progress = Math.min(timeElapsed / duration, 1);

                        // Ease-in-out function
                        const ease = progress < 0.5 ? 2 * progress * progress : -1 + (4 - 2 * progress) * progress;

                        window.scrollTo(0, startY + distance * ease);

                        if (timeElapsed < duration) {
                            requestAnimationFrame(animate);
                        }
                    }

                    requestAnimationFrame(animate);
                } catch (fallbackError) {
                    // Final fallback - just scroll to element
                    element.scrollIntoView();
                }
            }
        }

        // Add missing pagination functions
        function changeNewsPage(direction) {
            const { combined, page, perPage } = newsPagination;
            const totalPages = Math.ceil(combined.length / perPage);

            if (direction === 1 && page < totalPages) {
                newsPagination.page += 1;
            } else if (direction === -1 && page > 1) {
                newsPagination.page -= 1;
            }

            displayNewsPaginated();

            // Use enhanced smooth scrolling for pagination
            const newsContentElement = document.getElementById('news-content');
            smoothScrollTo(newsContentElement, { behavior: 'smooth', block: 'start' });
        }

        // Text expansion functionality
        function toggleExpand(bodyId, button) {
            const bodyElement = document.getElementById(bodyId);
            const isCollapsed = bodyElement.classList.contains('collapsed');

            if (isCollapsed) {
                bodyElement.classList.remove('collapsed');
                button.innerHTML = 'Show less â–²';
            } else {
                bodyElement.classList.add('collapsed');
                button.innerHTML = 'Show more â–¼';
                // Use enhanced smooth scrolling after collapsing
                setTimeout(() => {
                    smoothScrollTo(bodyElement, { behavior: 'smooth', block: 'center' });
                }, 100);
            }
        }
    </script>
</body>
</html>
